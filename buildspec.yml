version: 0.2


phases:
  install:
    commands:
      # Install Node.js
      # - echo Installing Node.js...
      # - curl -sL https://rpm.nodesource.com/setup_18.x | bash -
      # - yum install -y nodejs

      # Install Python dependencies
      - echo "Installing Python & CDK dependencies..."
      - pwd
      - pip install --upgrade pip
      - pip install -r cdk/requirements.txt
      - npm install -g aws-cdk

  pre_build:
    commands:
    - echo "****Setting up environment variables for React App****"
    - echo "VITE_API_BASE_URL=$VITE_API_BASE_URL" >> .env.production
    - echo "VITE_CALLBACK_URL=$VITE_CALLBACK_URL" >> .env.production
    - echo "VITE_LOGOUT_REDIRECT_URL=$VITE_LOGOUT_REDIRECT_URL" >> .env.production
    - echo "VITE_TOKEN_SIGN_IN_URL=$VITE_TOKEN_SIGN_IN_URL" >> .env.production
      - echo "Building React App..."
      - pwd
      - ls -la
      - cd code
      - npm install
      - npm run build
      - cd ..
      - echo "React App build completed."

  build:
    commands:
      - echo "CDK Synth..."
      - pwd
      - ls -la
      - cd cdk
      - cdk acknowledge 34892
      - cdk synth
      - echo "CDK Synth completed."

  post_build:
    commands:
      - echo "Deploying React App with CDK..."
      - cdk deploy --all --require-approval never
      - echo "CDK Deploy completed."

# artifacts:
#   files:
#     - "**/*"
